#!/usr/bin/env bash
# bin/compile <build-dir>

echo "-----> Installing Ghostscript 10.0.0 using build directory $1"

##############################################################
#   THIS SECTION IS FOR DOWNLOADING CUSTOM BUILT EXECUTABLE  #
##############################################################

# BUILD_DIR=$1
# cd $BUILD_DIR
# wget -q -O gs https://wize-dev.s3.us-west-2.amazonaws.com/heroku-buildpacks/gs-executable
# chmod +x gs

# LOCATION="$BUILD_DIR/vendor/gs"
# mkdir -p $LOCATION/bin
# mv gs $LOCATION/bin/gs

# echo "-----> Building runtime environment for Ghostscript to $LOCATION"

# mkdir -p $BUILD_DIR/.profile.d
# echo "export PATH=\"\$HOME/vendor/gs/bin:\$PATH\"" > $BUILD_DIR/.profile.d/ghostscript.sh



#################################################################
#   THIS SECTION IS FOR BUILDING THE GS EXECUTABLE FROM SOURCE  #
#        (doesn't seem to be working on heroku-24 stack)        #   
#################################################################


#PACKAGE="https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs10021/gs_10.02.1_amd64_snap.tgz"
# PACKAGE="https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs10021/ghostscript-10.02.1.tar.gz"

# PACKAGE="https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs10031/ghostscript-10.03.1.tar.gz"

# BUILD_DIR=$1
# LOCATION="$BUILD_DIR/vendor/gs"

# cd $BUILD_DIR


# wget -q -O gs.tgz $PACKAGE
# mkdir gs
# tar xvf gs.tgz --directory=gs --strip-components 1
# cd gs
# ./configure --disable-cups --disable-gtk --with-drivers=FILES
# make

# echo "-----> Make COMPLETED!"
# echo "-----> BIN files:"
# ls bin
# echo "-----> PWD files:"
# pwd
# ls .
# mkdir -p $LOCATION/bin
# mv bin/gs $LOCATION/bin/gs
# cd $BUILD_DIR
# rm -rf gs gs.tgz



#################################################################
#      THIS SECTION DOWNLOADS PRE-BUILD LINUX DISTRIBUTION      #
#################################################################

BUILD_DIR=$1
BIN_DIR="vendor/gs/bin"
LOCATION=$BUILD_DIR/$BIN_DIR
echo "-----> Installing Ghostscript"

GS_URL="https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs1000/ghostscript-10.0.0-linux-x86_64.tgz"
curl -L ${GS_URL} -o /tmp/ghostscript.tgz
mkdir -p ${BUILD_DIR}/ghostscript
tar xzf /tmp/ghostscript.tgz -C ${BUILD_DIR}/ghostscript --strip-components=1

mkdir -p $LOCATION
mv $BUILD_DIR/ghostscript/gs-1000-linux-x86_64 $LOCATION/gs
rm -rf $BUILD_DIR/ghostscript

echo "HOME: $HOME"
echo "BUILD_DIR: $BUILD_DIR"
ls $BUILD_DIR
echo "PWD: $(pwd)}"
ls .

echo "-----> Adding Ghostscript to PATH"
mkdir -p $BUILD_DIR/.profile.d
echo "export PATH=\"\$PATH:$HOME/$BIN_DIR\"" > $BUILD_DIR/.profile.d/ghostscript.sh

echo "-----> Ghostscript installation done"